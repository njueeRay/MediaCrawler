# 飞书多维表格数据同步方案

## 📋 项目概述

本方案旨在将 MediaCrawler 爬取的小红书数据自动同步到飞书多维表格，实现数据的可视化管理和分析。通过 Python 脚本调用飞书 API，支持批量同步、增量更新和实时监控。

## 🏗️ 系统架构

```
MediaCrawler (数据采集)
    ↓
数据格式化 (CSV/JSON → 飞书格式)
    ↓
飞书 API 客户端 (批量上传)
    ↓
飞书多维表格 (数据展示与分析)
```

### 核心组件

- **FeishuClient**: 飞书 API 交互客户端
- **XHSDataFormatter**: 小红书数据格式化器
- **FeishuSyncManager**: 同步流程管理器
- **sync_to_feishu.py**: 主执行脚本

## 📊 数据表结构设计

### 主表：小红书笔记数据

| 字段名称 | 类型 | 说明 | 数据源 |
|---------|------|------|--------|
| 笔记ID | 单行文本 | 唯一标识 | note_id |
| 标题 | 单行文本 | 笔记标题 | title |
| 内容摘要 | 多行文本 | 描述内容(限500字) | desc |
| 类型 | 单选 | 图文/视频 | type |
| 发布时间 | 日期时间 | 原发布时间 | time |
| 用户昵称 | 单行文本 | 发布者昵称 | nickname |
| 点赞数 | 数字 | 互动数据 | liked_count |
| 收藏数 | 数字 | 互动数据 | collected_count |
| 评论数 | 数字 | 互动数据 | comment_count |
| 分享数 | 数字 | 互动数据 | share_count |
| 地理位置 | 单行文本 | IP定位 | ip_location |
| 标签 | 多选 | 内容标签 | tag_list |
| 搜索关键词 | 单行文本 | 爬取关键词 | source_keyword |
| 笔记链接 | 超链接 | 原文链接 | note_url |
| 热度评分 | 数字 | 综合热度计算 | 公式计算 |
| 爬取时间 | 日期时间 | 数据采集时间 | last_modify_ts |

### 热度评分算法
```
热度评分 = (点赞数×1.0 + 收藏数×2.0 + 评论数×3.0 + 分享数×4.0) / 10
```

## 🚀 实施步骤

### 第一步：飞书应用准备

1. **创建飞书应用**
   - 访问 [飞书开放平台](https://open.feishu.cn/app)
   - 创建企业自建应用：`小红书数据同步器`
   - 获取 App ID 和 App Secret

2. **配置权限**
   ```
   bitable:app - 多维表格应用权限
   bitable:app:readonly - 读取权限  
   bitable:app:readwrite - 写入权限
   ```

3. **创建多维表格**
   - 新建多维表格：`小红书数据分析`
   - 获取 App Token

### 第二步：项目结构

```
MediaCrawler/
├── feishu_sync/
│   ├── __init__.py
│   ├── feishu_client.py      # 飞书API客户端
│   ├── data_formatter.py     # 数据格式化
│   ├── config.py            # 配置管理
│   └── sync_manager.py      # 同步管理器
├── sync_to_feishu.py        # 主执行脚本
├── requirements_feishu.txt   # 依赖包
└── .env                     # 环境配置
```

### 第三步：环境配置

1. **安装依赖**
   ```bash
   uv add requests python-dotenv schedule pandas
   ```

2. **配置 .env 文件**
   ```bash
   # 飞书配置
   FEISHU_APP_ID=your_app_id_here
   FEISHU_APP_SECRET=your_app_secret_here  
   FEISHU_APP_TOKEN=your_app_token_here
   FEISHU_TABLE_ID=
   
   # 可选配置
   FEISHU_BATCH_SIZE=500
   FEISHU_AUTO_SYNC=true
   DATA_DIR=data/xhs/
   ```

### 第四步：核心功能

#### 数据格式化特性
- **智能类型转换**: 自动处理时间戳、数字类型
- **文本清理**: 移除特殊字符，限制长度
- **标签解析**: 支持多种分隔符的标签字符串
- **去重处理**: 基于笔记ID自动去重
- **热度计算**: 加权算法评估内容热度

#### API限制处理
- **批量上传**: 每批最多500条记录
- **速率限制**: 请求间隔100ms防止限流
- **错误重试**: 自动重试机制
- **令牌管理**: 自动刷新访问令牌

## 📖 使用指南

### 基础使用

```bash
# 1. 首次创建表格
uv run sync_to_feishu.py --setup

# 2. 同步单个文件
uv run sync_to_feishu.py --file data/xhs/1_search_contents_2025-09-05.csv

# 3. 同步整个目录
uv run sync_to_feishu.py --dir data/xhs/

# 4. 自动监控模式
uv run sync_to_feishu.py --dir data/xhs/ --auto --interval 300
```

### 高级功能

```bash
# 指定文件格式
uv run sync_to_feishu.py --dir data/xhs/ --pattern "*.json"

# 验证同步状态
uv run validate_sync.py

# 查看同步日志
tail -f feishu_sync.log
```

### 集成到爬虫流程

在 `config/base_config.py` 中添加：
```python
# 飞书自动同步
ENABLE_FEISHU_AUTO_SYNC = True
```

在数据保存后自动触发：
```python
if config.ENABLE_FEISHU_AUTO_SYNC:
    os.system("uv run sync_to_feishu.py --dir data/xhs/ &")
```

## 🔧 配置说明

### 关键配置项

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| FEISHU_APP_ID | 飞书应用ID | 必填 |
| FEISHU_APP_SECRET | 飞书应用密钥 | 必填 |
| FEISHU_APP_TOKEN | 多维表格Token | 必填 |
| FEISHU_TABLE_ID | 数据表ID | 可选，自动创建 |
| FEISHU_BATCH_SIZE | 批量上传大小 | 500 |
| FEISHU_AUTO_SYNC | 自动同步开关 | true |

### 数据源支持

- **CSV格式**: 标准逗号分隔值文件
- **JSON格式**: 单个对象或对象数组
- **实时监控**: 目录变化自动同步

## 📈 数据分析功能

### 内置计算字段

1. **热度评分**: 综合互动数据的加权评分
2. **发布趋势**: 按时间统计发布量
3. **标签统计**: 热门标签分析
4. **用户画像**: 高互动用户识别

### 可视化看板

- **热门内容**: 热度评分Top榜单
- **趋势分析**: 时间序列图表
- **地域分布**: 地理位置统计
- **标签云图**: 关键词可视化

## 🚨 注意事项

### API限制
- 飞书API有调用频率限制，建议批量操作
- 单次最多上传500条记录
- 访问令牌有效期2小时，需自动刷新

### 数据质量
- 确保CSV文件编码为UTF-8
- 时间戳格式需统一（毫秒或秒级）
- 大文本字段会被自动截断

### 安全建议
- 敏感配置使用环境变量
- 定期轮换应用密钥
- 监控API调用日志

## 🔍 故障排查

### 常见问题

1. **认证失败**
   - 检查App ID和Secret是否正确
   - 确认应用权限已正确配置

2. **上传失败**
   - 检查数据格式是否符合要求
   - 确认网络连接正常

3. **数据丢失**
   - 查看同步日志确认错误原因
   - 检查去重逻辑是否正确

### 日志分析
```bash
# 查看错误日志
grep ERROR feishu_sync.log

# 查看成功率统计
grep "同步完成" feishu_sync.log | tail -10
```

## 📞 技术支持

- **项目地址**: MediaCrawler/feishu_sync/
- **日志文件**: feishu_sync.log
- **配置示例**: .env.example

---

*最后更新：2025年9月5日*
*版本：v1.0*